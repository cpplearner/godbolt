<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<style>
button, input, select { font-size: 16px; }
.code, .output { font-family: monospace; word-break: break-all; white-space: pre-wrap; }
.code {
	width: calc(100vw - 42px);
	height:calc(100vh - 100px);
	margin: 1px;
}
.container { width: calc(100vw - 35px); overflow: auto; }
.controller { display: table-cell; }
select.compiler,
input.options {
	width: calc(100vw - 36px);
	box-sizing: border-box;
	padding: 1px;
	margin: 1px;
}
.output .bold { font-weight: bold; }
.output .red { color: red; }
.output .green { color: green; }
.output .blue { color: blue; }
.output .magenta { color: magenta; }
.output .cyan { color: darkcyan; }
.output .toggle { cursor: pointer; }
</style>
</head>
<body>
<textarea class="code"></textarea>
<div class="container">
<div class="controller">
<select class="compiler">
<option value="gsnapshot">x86-64 gcc (snapshot)</option>
</select>
<input class="options" value="-std=c++1z -Wall -pedantic -fdiagnostics-color=always" />
<button class="asm" data-field="asm">assembly</button>
<button class="stderr" data-field="stderr">stderr</button>
<button class="stdout" data-field="stdout">stdout</button>
</div>
<div class="controller">
<select class="compiler">
<option value="clang_trunk">x86-64 clang (trunk)</option>
</select>
<input class="options" value="-std=c++1z -Wall -pedantic -fdiagnostics-color=always -stdlib=libc++" />
<button class="asm" data-field="asm">assembly</button>
<button class="stderr" data-field="stderr">stderr</button>
<button class="stdout" data-field="stdout">stdout</button>
</div>
<div class="controller">
<select class="compiler">
<option value="cl19_64">x86-64 CL 19 2017 RTW</option>
</select>
<input class="options" value="/EHsc /std:c++latest /permissive-" />
<button class="asm" data-field="asm">assembly</button>
<button class="stderr" data-field="stderr">stderr</button>
<button class="stdout" data-field="stdout">stdout</button>
</div>
</div>
<div class="output"></div>
<script>
let create = (s, o) => Object.assign(document.createElement(s), o);
let request = (url, init) => fetch('https://godbolt.org/api'+url, init).then(x => x.json());
let getCompilers = () => request('/compilers', { headers: { 'Accept': 'application/json' }});
function compile(id, {source = '', options = '', filters}) {
	let body = JSON.stringify({ source, options, filters });
	let headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
	return request('/compiler/'+id+'/compile', { method: 'post', headers, body });
}
getCompilers().then((data) => {
	for (let compiler of document.querySelectorAll('.compiler')) {
		let curid = compiler.selectedOptions[0].value;
		compiler.innerText = '';
		for (let {name, id} of data)
			compiler.append(create('option', { value: id, innerText: name, selected: id === curid }));
	}
});
let pending_display = Promise.resolve();
let output = document.querySelector('.output');
let display = (data, attr) => pending_display.then(() => {
	let o = data[attr];
	output.innerText = '';
	for (let {text} of o)
		output.append(create('div', { innerText: text }));
	output.dispatchEvent(new CustomEvent('content-changed'), { detail: { data, attr, o } });
});
let cache = [];
document.addEventListener('click', (e) => {
	let button = e.target;
	let controller = button.closest('.controller');
	if (button.tagName !== 'BUTTON' || !controller) return;
	let compiler = controller.querySelector('.compiler').selectedOptions[0].value;
	let options = controller.querySelector('.options').value;
	let source = document.querySelector('.code').value;
	let s = JSON.stringify({ compiler, options, source });
	for (let c of cache)
		if (c.input === s) {
			display(c.output, button.dataset.field);
			return;
		}
	compile(compiler, { source, options }).then((data) => {
		if (data.okToCache)
			cache.push({ input: s, output: data });
		display(data, button.dataset.field);
	});
});
function colorize() {
	for (let line of output.children) {
		line.innerHTML = line.innerHTML.replace(/\033\[(.*?)m(?:\033\[K)?(.*?)(?=\033|$)/g, (m, p1, p2) => {
			const classmap = {
				1: 'bold',
				31: 'red',
				32: 'green',
				34: 'blue',
				35: 'magenta',
				36: 'cyan',
			};
			let classes = p1.split(';').map(x => classmap[+x]).join(' ');
			return '<span class="'+classes+'">'+p2+'</span>';
		});
		if (line.children.length === 1 && line.children[0].matches('.bold.green'))
		    line.children[0].classList.remove('bold');
	}
}
output.addEventListener('content-changed', colorize);
function shorten_filename() {
	for (let line of output.children)
		line.innerHTML = line.innerHTML.replace(/\/opt\/compiler-explorer\/.*?\/include\/c\+\+\/.*?\//g, (m) => {
			let span = create('span', { innerText: '.../', title: m, className: 'toggle toggle-short' });
			span.dataset.short = span.innerText;
			return span.outerHTML;
		});
}
output.addEventListener('content-changed', shorten_filename);
output.addEventListener('click', function (e) {
	let span = e.target;
	if (!span || !span.classList.contains('toggle')) return;
	if (span.classList.contains('toggle-short')) {
		span.classList.replace('toggle-short', 'toggle-long');
		span.innerText = span.title;
	} else {
		span.classList.replace('toggle-long', 'toggle-short');
		span.innerText = span.dataset.short;
	}
});
</script>
</body>
</html>
