<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<style>
button, input, select { font-size: 16px; }
.code, .output { font-family: monospace; word-break: break-all; white-space: pre-wrap; }
.code {
	width: calc(100vw - 40px);
	height:calc(100vh - 100px);
	margin: 1px;
}
select.compiler,
input.options {
	width: calc(100vw - 40px);
	padding: 1px;
	margin: 1px;
}
.output .bold { font-weight: bold; }
.output .red { color: red; }
.output .green { color: green; }
.output .blue { color: blue; }
.output .magenta { color: magenta; }
.output .cyan { color: darkcyan; }
.output .elided-path-fragment { cursor: pointer; }
</style>
</head>
<body>
<textarea class="code"></textarea>
<div class="controller">
<select class="compiler">
<option value="gsnapshot">x86-64 gcc (snapshot)</option>
</select>
<input class="options" value="-std=c++1z -Wall -pedantic -fdiagnostics-color=always" />
<button class="asm" data-field="asm">assembly</button>
<button class="stderr" data-field="stderr">stderr</button>
<button class="stdout" data-field="stdout">stdout</button>
</div>
<div class="output"></div>
<script>
let create = (s, o) => Object.assign(document.createElement(s), o);
let request = (url, init) => fetch('https://godbolt.org/api'+url, init).then(x => x.json());
let getCompilers = () => request('/compilers', { headers: { 'Accept': 'application/json' }});
function compile(id, {source = '', options = '', filters}) {
	let body = JSON.stringify({ source, options, filters });
	let headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
	return request('/compiler/'+id+'/compile', { method: 'post', headers, body });
}
getCompilers().then(function (data) {
	let compiler = document.querySelector('.compiler');
	let curid = compiler.selectedOptions[0].value;
	compiler.innerText = '';
	for (let {name, id} of data)
		compiler.append(create('option', { value: id, innerText: name, selected: id === curid }));
});
let pending_display = Promise.resolve();
let output = document.querySelector('.output');
let display = (data, attr) => pending_display.then(function () {
	let o = data[attr];
	output.innerText = '';
	for (let {text} of o)
		output.append(create('div', { innerText: text }));
	output.dispatchEvent(new CustomEvent('content-changed'), { detail: { data, o } });
});
let cache = [];
document.addEventListener('click', function (e) {
	let button = e.target;
	let controller = button.closest('.controller');
	if (!button.matches('button') || !controller) return;
	let compiler = controller.querySelector('.compiler').selectedOptions[0].value;
	let options = controller.querySelector('.options').value;
	let source = document.querySelector('.code').value;
	let s = JSON.stringify({ compiler, options, source });
	for (let c of cache)
		if (c.input === s) {
			display(c.output, button.dataset.field);
			return;
		}
	compile(compiler, { source, options }).then(function (data) {
		if (data.okToCache)
			cache.push({ input: s, output: data });
		display(data, button.dataset.field);
	});
});
function colorize() {
	for (let line of output.children)
		line.innerHTML = line.innerHTML.replace(/\033\[(.*?)m(?:\033\[K)?(.*?)(?=\033|$)/g, function (m, p1, p2) {
			const classmap = {
				1: 'bold',
				31: 'red',
				32: 'green',
				34: 'blue',
				35: 'magenta',
				36: 'darkcyan',
			};
			let classes = p1.split(';').map(x => classmap[+x]).join(' ');
			return '<span class="'+classes+'">'+p2+'</span>';
		});
}
output.addEventListener('content-changed', colorize);
function shorten_filename() {
	for (let line of output.children)
		line.innerHTML = line.innerHTML.replace(/\/opt\/compiler-explorer\/.*?\/include\/c\+\+\/.*?\//g, function (m) {
			let span = create('span', { innerText: '.../', title: m, className: 'elided-path-fragment' });
			return span.outerHTML;
		});
}
output.addEventListener('content-changed', shorten_filename);
output.addEventListener('click', function (e) {
	let span = e.target;
	if (!span || !span.classList.contains('elided-path-fragment')) return;
	span.innerText = span.title;
});
</script>
</body>
</html>
