<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Compiler Explorer Tool</title>
<style>
button, label { font-size: 20px }
.code, .output { font-family: monospace; word-break: break-all; white-space: pre-wrap }
.code { width: calc(100vw - 42px); height: calc(100vh - 200px); margin: 1px }
.code.expanded { height: calc(100vh - 30px) }
.expand { width: 100%; position: sticky; top: 0; left: 0 }
.container { width: calc(100vw - 35px); overflow: auto }
.controller { display: table-cell }
.controller label { white-space: nowrap }
select.compiler,
input.options {
	width: calc(100vw - 36px);
	box-sizing: border-box;
	padding: 1px;
	margin: 1px;
}
.output .bold { font-weight: bold }
.output .red { color: red }
.output .green { color: green }
.output .blue { color: blue }
.output .magenta { color: magenta }
.output .cyan { color: darkcyan }
.output .toggle { cursor: pointer }
</style>
<textarea class="code"></textarea>
<div class="container">
<button class="expand">v</button>
<p class="controller">
<select class="compiler"><option value="gsnapshot">x86-64 gcc (snapshot)</select>
<input class="options" value="-std=c++1z -Wall -pedantic -fdiagnostics-color=always">
<p class="controller">
<select class="compiler"><option value="clang_trunk">x86-64 clang (trunk)</select>
<input class="options" value="-std=c++1z -Wall -pedantic -fdiagnostics-color=always -fmodules -stdlib=libc++">
<p class="controller">
<select class="compiler"><option value="cl19_64">x86-64 CL 19 2017 RTW</select>
<input class="options" value="/EHsc /std:c++latest /permissive-">
</div>
<output class="output"></output>
<template id="filters">
<label><input type=checkbox name="binary">binary</label>
<label><input type=checkbox name="labels" checked>labels</label>
<label><input type=checkbox name="intel" checked>intel</label>
<label><input type=checkbox name="commentOnly" checked>comments</label>
<label><input type=checkbox name="directives" checked>directives</label>
<div>
<button class="asm" data-field="asm">assembly</button>
<button class="stderr" data-field="stderr">stderr</button>
<button class="stdout" data-field="stdout">stdout</button>
<button class="ast" data-field="ast">ast</button>
</div>
</template>
<script>
let create = (tag, props) => Object.assign(document.createElement(tag), props);
let request = (url, init) => fetch('https://godbolt.org/api'+url, init).then(x => x.json());
let getCompilers = () => request('/compilers', { headers: { 'Accept': 'application/json' }});
function compile(id, body) {
	const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
	return request('/compiler/'+id+'/compile', { method: 'post', headers, body });
}
let code = document.querySelector('.code');
let output = document.querySelector('.output');
document.querySelector('.expand').addEventListener('click', (e) => {
	e.target.innerText = code.classList.toggle('expanded') ? '^' : 'v';
});
for (let controller of document.querySelectorAll('.controller'))
	controller.append(document.querySelector('template#filters').content.cloneNode(true));
getCompilers().then((data) => {
	for (const compiler of document.querySelectorAll('.compiler')) {
		const curid = compiler.selectedOptions[0].value;
		compiler.innerText = '';
		for (const {name, id} of data)
			compiler.append(create('option', { value: id, innerText: name, selected: id === curid }));
	}
});
function display(data, attr) {
	output.innerText = '';
	if (attr === 'ast')
		output.append(create('div', { innerText: data.astOutput }));
	else
		for (const {text} of data[attr])
			output.append(create('div', { innerText: text }));
	output.dispatchEvent(new CustomEvent('content-changed'), { detail: { data, attr } });
};
let cache = {};
document.addEventListener('click', (e) => {
	const button = e.target;
	const controller = button.closest('.controller');
	if (!button.matches('button') || !controller) return;
	const compiler = controller.querySelector('.compiler').selectedOptions[0].value;
	const userArguments = controller.querySelector('.options').value;
	const compilerOptions = { produceAst: true };
	const source = code.value;
	const filters = {};
	for (let checkbox of controller.querySelectorAll('input[type="checkbox"]'))
		filters[checkbox.name] = checkbox.checked;
	const s = JSON.stringify({ source, compiler, options: { userArguments, compilerOptions, filters } });
	if (cache[s])
		display(cache[s], button.dataset.field);
	else
		compile(compiler, s).then((data) => {
			if (data.okToCache)
				cache[s] = data;
			display(data, button.dataset.field);
		});
});
function colorize() {
	for (const line of output.children) {
		line.innerHTML = line.innerHTML.replace(/\033\[(.*?)m(?:\033\[K)?(.*?)(?=\033|$)/g, (m, p1, p2) => {
			const classmap = {
				1: 'bold', 31: 'red', 32: 'green', 34: 'blue', 35: 'magenta', 36: 'cyan',
			};
			const classes = p1.split(';').map(x => classmap[+x]).join(' ');
			return '<span class="'+classes+'">'+p2+'</span>';
		});
		if (line.children.length === 1 && line.children[0].matches('.bold.green'))
			line.children[0].classList.remove('bold');
	}
}
output.addEventListener('content-changed', colorize);
function shorten_filename() {
	for (const line of output.children)
		line.innerHTML = line.innerHTML.replace(/\/opt\/compiler-explorer\/.*?\/include\/c\+\+\/.*?\//g, (m) => {
			const span = create('span', { innerText: '.../', title: m, className: 'toggle toggle-abbr' });
			span.dataset.abbr = span.innerText;
			return span.outerHTML;
		});
}
output.addEventListener('content-changed', shorten_filename);
output.addEventListener('click', (e) => {
	const span = e.target;
	if (!span || !span.classList.contains('toggle')) return;
	span.innerText = span.classList.toggle('toggle-abbr') ? span.dataset.abbr : span.title;
});
</script>
