<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Compiler Explorer Tool</title>
<style>
body { overflow: scroll }
button, label { font-size: 20px }
.toggle { cursor: pointer }
.toggle > .full { display: none }
.toggle.full > .abbr { display: none }
.toggle.full > .full { display: unset }
#expand { position: absolute; top: 9px; right: 10px }
#expand.full + #code { height: calc(100vh - 50px) }
#code, #output { font-family: monospace; word-break: break-all; white-space: pre-wrap }
#code { width: calc(100vw - 42px); height: calc(100vh - 300px); margin: 1px }
#container { width: calc(100vw - 35px); padding: 0; margin: 0; overflow: auto }
.controller { display: table-cell }
.controller label { white-space: nowrap }
#goptions, .options, .compiler, .libs, p, #fromlink { width: calc(100vw - 36px); box-sizing: border-box; padding: 1px; margin: 1px }
.libs { height: 100px; overflow: scroll }
.tools > div, #fromlink { display: flex }
.tools > div > button, #fillinput { flex: none }
.tools > div > input, #sl { width: 100% }
#lnk { display: block; word-break: break-all; white-space: pre-wrap }
#loading[data-show="0"] { display: none }
#output .bold { font-weight: bold }
#output .red { color: red }
#output .green { color: green }
#output .yellow { color: orange }
#output .blue { color: blue }
#output .magenta { color: magenta }
#output .cyan { color: darkcyan }
#output .bold.green:only-child { font-weight: normal }
</style>
<span id="expand" class="toggle"><button class="abbr">v</button><button class="full">^</button></span>
<textarea id="code"></textarea>
<input id="goptions">
<ul id="container"></ul>
<div id="fromlink"><input id="sl" value="https://godbolt.org/z/TdJXRE"><button id="fillinput">fill</button></div>
<a id="lnk"></a>
<div id="loading" data-show="-2">loading...</div>
<output id="output"></output>
<template id="panel">
<input class="options">
<select class="compiler"><option value="gsnapshot"></select>
<details><summary>include libs</summary><div class="libs"></div></details>
<label><input type=checkbox name="binary" data-enableif="supportsBinary">binary</label>
<label hidden><input type=checkbox name="execute">execute</label>
<label><input type=checkbox name="labels" checked>labels</label>
<label><input type=checkbox name="directives" checked>directives</label>
<label><input type=checkbox name="commentOnly" checked>commentOnly</label>
<label><input type=checkbox name="trim" checked>trim</label>
<label><input type=checkbox name="intel" data-enableif="supportsIntel" checked>intel</label>
<label><input type=checkbox name="demangle" data-enableif="supportsDemangle" checked>demangle</label>
<p>
<button name="asm">assembly</button>
<button name="stderr">stderr</button>
<button name="stdout">stdout</button>
<button name="ast" data-enableif="supportsAstView">ast</button>
<button name="makelink">link</button>
<details><summary>tools</summary><div class="tools"></div></details>
</template>
<script>
let request = (url, r = {}, type = 'application/json', morehdrs = { 'Content-Type': type, 'Accept': type }) =>
	fetch('https://godbolt.org/api'+url, { ...r, headers: { ...r.headers, ...morehdrs } });
let getCompilers = async (use_cache = sessionStorage.compilers) =>
	JSON.parse(use_cache || (sessionStorage.compilers = await request('/compilers').then(x => x.text())));
let getInfo = (s) => request('/shortlinkinfo/'+s).then(x => x.json());
let compile = (id, body) => request('/compiler/'+id+'/compile', { method: 'post', body }).then(x => x.json());
let create = (tag, props) => Object.assign(document.createElement(tag), props);
let init = (node, nodes = []) => {
	Object.assign(node, { textContent: '' }).append(...nodes);
	return node;
};
let make_toggle = ({ abbr, full, tooltip = '' }) => '<span class="toggle"><span class="abbr" title="'+tooltip+'">'
	+abbr+'</span><span class="full">'+full+'</span></span>';
document.addEventListener('click', e => e.target.closest('.toggle') && e.target.closest('.toggle').classList.toggle('full'));
let panel_tmplt = document.querySelector('#panel').content;
document.querySelector('#container').append(init(create('li', { className: 'controller' }), [panel_tmplt.cloneNode(true)]));
let compilers = [];
let reinitpanel = (panel, select = panel.querySelector('.compiler'), c = compilers.find(x => x.id === select.value)) => {
	if (!c) return;
	[...panel.querySelectorAll('[data-enableif]')].forEach(x => x.disabled = !c[x.dataset.enableif]);
	const t = Object.entries(c.tools || {}).map(x => create('button', { name: x[1].tool.id, textContent: x[0] }));
	init(panel.querySelector('.tools'), t.map(x => init(create('div'), [x, create('input')])));
	init(panel.querySelector('.libs'), Object.entries(c.libs || {}).map(([id, { name, url, description, versions }]) => {
		const s = init(create('details'), [create('summary', { textContent: name })]);
		for (const v of Object.values(versions)) {
			const i = init(create('label'), [create('input', { type: 'checkbox' }), v.version]);
			i.querySelector('input').dataset.path = JSON.stringify(v.path);
			s.append(i);
		}
		return s;
	}));
};
let syncwithlibs = (options, path, checked, rpl = (p, r) => options.value = options.value.replace(p, r)) => {
	if (checked) return path.forEach(s => !options.value.includes(s) && rpl(/ *$/, ' -I'+s));
	rpl(RegExp(` *(${path.map(s => '-I'+s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|')}) *`, 'g'), ' ');
};
['input', 'change'].forEach(ev => document.addEventListener(ev, ({ target, panel = target.closest('.controller') }) => {
	if (!panel) return;
	if (target.matches('.compiler')) return reinitpanel(panel);
	if (target.type === 'checkbox' && target.dataset.path)
		return syncwithlibs(panel.querySelector('.options'), JSON.parse(target.dataset.path), target.checked);
	else if (target.matches('.options')) {
		for (const checkbox of panel.querySelectorAll('input[data-path]')) {
			const path = JSON.parse(checkbox.dataset.path);
			checkbox.checked = path.every(s => target.value.includes(s));
			checkbox.indeterminate = !checkbox.checked && path.some(s => target.value.includes(s));
		}
	}
}));
getCompilers().then((data, gN = v => v.groupName || v.group, labels = [...new Set(data.map(gN))]) => {
	compilers = data.sort((x, y) => x.id.localeCompare(y.id));
	for (const c of [...document.querySelectorAll('.compiler'), panel_tmplt.querySelector('.compiler')])
		reinitpanel(init(c, labels.map(v => init(create('optgroup', { label: v }), data.filter(e => gN(e) === v)
			.map(e => create('option', { text: e.lang+' : '+e.name, value: e.id, selected: e.id === c.value }))
		))).parentNode);
	document.querySelector('#loading').dataset.show++;
});
let loadstate = (data) => {
	document.querySelector('#code').value = data.sessions[0].source;
	init(document.querySelector('#container'), data.sessions[0].compilers.map((c) => {
		const panel = panel_tmplt.cloneNode(true);
		[panel.querySelector('.options').value, panel.querySelector('.compiler').value] = [c.options, c.id];
		[...panel.querySelectorAll('input[type=checkbox]')].forEach(e => e.checked = c.filters[e.name]);
		reinitpanel(panel);
		return init(create('li', { className: 'controller' }), [panel]);
	}));
};
let shortlink = () => document.querySelector('#sl').value.match(/\/z\/([-\w]+)/)[1];
Promise.resolve(localStorage.preload ? JSON.parse(localStorage.preload) : getInfo(shortlink())).then((x) => {
	localStorage.preload = JSON.stringify(x);
	loadstate(x);
	document.querySelector('#loading').dataset.show++;
});
let actions = {};
let cache = {};
let cl_prelude = ((p = 'extern template ', w = 'std::wostream') => {
	const int_types = 'short,int,long,long long'.replace(/[^,]+/g, '$&,unsigned $&');
	const types = (int_types+',float,double,long double,bool,const void*').split(',');
	let s = types.map(type => p+'<stream>& <stream>::operator<<('+type+');\n').join('');
	s += ['char', 'const char*'].map(t => p+'<stream>& std::operator<<(<stream>&, '+t+');\n').join('');
	s = ['std::ostream', 'std::wostream'].map(stream => s.replace(/<stream>/g, stream)).join('');
	return s + ['wchar_t', 'const wchar_t*'].map(t => p+w+'& std::operator<<('+w+'&, '+t+');\n').join('');
})();
document.addEventListener('click', async ({ target: button, panel = button.closest('.controller') }) => {
	document.querySelector('#loading').dataset.show++;
	try {
		if (button.matches('#fillinput')) return loadstate(await getInfo(shortlink()));
		if (!button.matches('button') || !panel) return;
		let source = document.querySelector('#code').value;
		if (panel.querySelector('.compiler > [label^="MSVC"] > :checked'))
			source = source.replace(/^[ \t]*#[ \t]*include[ \t]*<iostream>[ \t]*\n/, '$&'+cl_prelude);
		const compiler = panel.querySelector('.compiler').value;
		const userArguments = document.querySelector('#goptions').value+' '+panel.querySelector('.options').value;
		const compilerOptions = { produceAst: true };
		const checkboxes = [...panel.querySelectorAll(':scope > label > input[type=checkbox]')];
		const filters = Object.assign(...checkboxes.map((e) => ({ [e.name]: e.checked })));
		const tools = [...panel.querySelectorAll('.tools button')].map(x => ({ id: x.name, args: x.nextSibling.value }));
		const lnk = Object.assign(init(document.querySelector('#lnk')), { href: '' });
		if (button.name === 'makelink') {
			const esc = (s) => `'${s.replace(/['!]/g, '!$&')}'`;
			const flt = `(${checkboxes.map(e => `${e.name}:'${+!e.checked}'`)})`;
			let s = `g:!((g:!((g:!((h:codeEditor,i:(j:1,source:${esc(source)}),l:'5')),l:'4'),(g:!((${
			`h:compiler,i:(compiler:${compiler},filters:${flt},options:${esc(userArguments)},source:1)`
			},l:'5')),l:'4'),(g:!((h:output,i:(compiler:1,editor:1),l:'5')),l:'4')),l:'2')),version:4`;
			s = encodeURIComponent(s).replace(/%2C/g, ',').replace(/%3A/g, ':').replace(/%20/g, '+');
			lnk.textContent = lnk.href = 'https://godbolt.org/#'+s;
			return;
		}
		const k = JSON.stringify({ source, compiler, options: { userArguments, compilerOptions, filters, tools } });
		const data = cache[k] || await compile(compiler, k).then(a => a.okToCache ? cache[k] = a : a);
		const output = document.querySelector('#output');
		if (button.closest('.tools')) {
			const { stdout } = data.tools.find(x => x.id === button.name);
			init(output, stdout.map(t => create('div', { textContent: t.text })));
		} else if (button.name === 'ast')
			init(output, [create('div', { textContent: data.astOutput })]);
		else
			init(output, data[button.name].map(t => create('div', { textContent: t.text })));
		const h = output.innerHTML;
		output.innerHTML = Object.values(actions).reduce((h, f) => f(h, { output, attr: button.name }), h);
	} finally {
		document.querySelector('#loading').dataset.show--;
	}
});
let add_action = (f) => actions[f.name] = window[f.name] = f;
let replace = (html, re, cb) => html.replace(/>([^]+?)</g, (m, p1) => `>${p1.replace(re, cb)}<`);
add_action(function colorize(html, e) {
	if (e.attr === 'asm') return html;
	const classmap = {
		0: '', 1: 'bold', 31: 'red', 32: 'green', 33: 'yellow', 34: 'blue', 35: 'magenta', 36: 'cyan',
	};
	return replace(html, /\x1B\[(.*?)m(?:\x1B\[K)?(.*?)(?=\x1B|$)/mg,
		(m, p1, p2) => '<span class="'+p1.split(';').map(x => classmap[+x]).join(' ')+'">'+p2+'</span>');
});
add_action(function shorten_filename(html, e) {
	const f = [
		'/opt/compiler-explorer/(?:libs/(?:.*?/include/(?=[^/]*?/))?|.*?/include/c\\+\\+/[^/]*?/)',
		'/tmp/compiler-explorer-compiler.*?/',
	];
	return replace(html, RegExp(f.join('|'), 'g'), m => make_toggle({ abbr: '.../', full: m, tooltip: m }));
});
add_action(function strip_ast_output(html, e) {
	if (e.attr !== 'ast') return html;
	const raddress = /<span class=" yellow"> 0x[a-f0-9]+<\/span>/g;
	const rimp = /<[^>]+>\|-(<[^>]+>)+\w+(<[^>]+>)+ &lt;(<[^>]+>)+&gt; (<[^>]+>)+ [^]*?\n(?=<[^>]+>[|`]-)/g;
	return html.replace(raddress, '').replace(rimp, '');
});
add_action(function shorten_decl(html, e) {
	return replace(html, /^.*$/g, (m) => {
		function getHTML(range, s = '') {
			let curidx = range.left;
			for (const r of range.nested) {
				const [p, c] = [m.slice(curidx, r.left), m.slice(r.left, curidx = r.right)];
				if (r.right - r.left - (r.sl+r.sr).length > 30)
					s += p+make_toggle({ abbr: r.sl+'...'+r.sr, full: getHTML(r), tooltip: c });
				else
					s += p+c;
			}
			return s + m.slice(curidx, range.right);
		}
		try {
			const symidx = [];
			for (let i, re = /&lt;|&gt;|\(|\)|\[|\]/g; i = re.exec(m);)
				symidx.push(i);
			const stack = [{ left: 0, right: m.length, nested: [] }];
			const last = (i = 1) => stack[stack.length - i];
			for (const { 0: str, index } of symidx) {
				if (['&lt;', '(', '['].includes(str))
					stack.push({ left: index, sl: str, nested: [] });
				else {
					while (str !== '&gt;' && last().sl !== { ')': '(', ']': '[' }[str] && last(2))
						last(2).nested.push(...stack.pop().nested);
					if (!last().right && (str !== '&gt;' || last().sl === '&lt;') && last(2))
						last(2).nested.push({ right: index + str.length, sr: str, ...stack.pop() });
				}
			}
			while (last().sl && last(2))
				last(2).nested.push(...stack.pop().nested);
			return getHTML(stack[0]);
		} catch (e) {
			return m;
		}
	});
});
</script>
